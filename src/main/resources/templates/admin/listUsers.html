<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Users - GameShop</title>

<!-- CSRF tokens for AJAX -->
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<link href="/css/styles.css" rel="stylesheet" />
<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" th:href="@{/}">GameShop</a>
      <button class="navbar-toggler" type="button"
        data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false"
        aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link active"
            th:href="@{/games}">Games</a></li>
        </ul>
        <hr class="navbar-collapse-divider-lg" />
        <ul class="navbar-nav ms-auto">
          <li class="nav-item" th:if="${currentUser != null}"><a
            class="nav-link" th:href="@{/profile}"
            th:text="${currentUser}"></a></li>
          <li class="nav-item" th:if="${currentUser == null}"><a
            class="nav-link" th:href="@{/register}">Register</a></li>
          <li class="nav-item" th:if="${currentUser == null}"><a
            class="nav-link" th:href="@{/login}">Login</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container mt-5">
    <div class="d-flex align-items-center justify-content-between mb-4">
      <h2 class="mb-0">Manage Users</h2>
      <a class="btn btn-primary" th:href="@{/admin/users/new}">+ New user</a>
    </div>

    <div class="table-responsive">
      <table id="usersTable" class="table table-striped table-hover table-bordered" style="width:100%">
        <thead class="table-dark">
          <tr>
            <th>Username</th>
            <th>Full Name</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="user : ${users}">
            <td>
              <div class="d-flex align-items-center">
                <div class="me-3" style="width:48px; height:48px; overflow:hidden; border-radius:6px;">
                  <img th:if="${user.imageUrl != null}" th:src="${user.imageUrl}" alt="cover" class="img-cover" />
                  <div th:if="${user.imageUrl == null}" class="bg-secondary text-white d-flex align-items-center justify-content-center" th:text="${user.initials}" style="width:48px; height:48px; font-size: 30px;"></div>
                </div>
                <div>
                  <div th:text="${user.username}">Username</div>
                  <small class="text-muted" th:text="${user.email}">email</small>
                </div>
              </div>
            </td>
            <td th:text="|${user.firstName} ${user.lastName}|">Full Name</td>
            <td class="text-center">
              <div th:if="${currentUser != user.username}" class="btn-group" role="group" aria-label="actions">
                <a th:href="@{/admin/users/edit/{id}(id=${user.id})}" class="btn btn-sm btn-outline-primary">Edit</a>
                <button type="button" th:if="${!user.disabled}" class="btn btn-sm btn-outline-warning disable-btn" th:data-id="${user.id}">Disable</button>
                <button type="button" th:if="${user.disabled}" class="btn btn-sm btn-outline-success enable-btn" th:data-id="${user.id}">Enable</button>
                <button type="button" class="btn btn-sm btn-outline-danger delete-btn" th:data-id="${user.id}">Delete</button>
              </div>
              <div th:if="${currentUser == user.username}" class="btn-group" role="group" aria-label="actions">
                <a th:href="@{/admin/users/edit/{id}(id=${user.id})}" class="btn btn-sm btn-outline-primary disabled" aria-disabled="true">Edit</a>
                <button type="button" th:if="${!user.disabled}" class="btn btn-sm btn-outline-warning disable-btn" th:data-id="${user.id}" disabled>Disable</button>
                <button type="button" th:if="${user.disabled}" class="btn btn-sm btn-outline-success enable-btn" th:data-id="${user.id}" disabled>Enable</button>
                <button type="button" class="btn btn-sm btn-outline-danger delete-btn" th:data-id="${user.id}" disabled>Delete</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
    $(document).ready(function() {
      // Read CSRF meta tags populated by Thymeleaf/Spring
      const csrfToken = $('meta[name="_csrf"]').attr('content');
      const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
      // Initialize DataTable
      $('#usersTable').DataTable({
        responsive: true,
        columnDefs: [
          { orderable: false, targets: [2] } // actions not orderable
        ],
        pageLength: 10,
        lengthMenu: [ [10, 25, 50], [10, 25, 50] ]
      });
      // Disable handler (example: POST to /admin/users/disable/{id})
      $(document).on('click', '.disable-btn', function() {
        const id = $(this).data('id');
        if (!confirm('Disable this user?')) return;
      	$.ajax({
          type: "POST",
          url: `/admin/users/disable/${id}`,
          beforeSend: (xhr) => { if (csrfHeader && csrfToken) xhr.setRequestHeader(csrfHeader, csrfToken) },
          success: () => window.location.reload(), // change table without reloading the page
          error: () => alert("Failed to disable")
        });
      });
      // Enable handler (example: POST to /admin/users/enable/{id})
      $(document).on('click', '.enable-btn', function() {
        const id = $(this).data('id');
        if (!confirm('Enable this user?')) return;
      	$.ajax({
          type: "POST",
          url: `/admin/users/enable/${id}`,
          beforeSend: (xhr) => { if (csrfHeader && csrfToken) xhr.setRequestHeader(csrfHeader, csrfToken) },
          success: () => window.location.reload(), // change table without reloading the page
          error: () => alert("Failed to enable")
        });
      });
      // Delete handler (example: DELETE to /admin/users/{id})
      $(document).on('click', '.delete-btn', function() {
        const id = $(this).data('id');
        if (!confirm('Permanently delete this game?')) return;
      	$.ajax({
      	  type: "DELETE",
      	  url: `/admin/users/${title}`,
      	  beforeSend: (xhr) => { if (csrfHeader && csrfToken) xhr.setRequestHeader(csrfHeader, csrfToken) },
      	  success: () => window.location.reload(), // change table without reloading the page
      	  error: () => alert("Failed to delete")
      	});
      });
    });
  </script>
</body>
</html>
